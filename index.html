<!DOCTYPE html>
<html>

<head>
    <script src="/socket.io/socket.io.js"></script>

    <title> VoxelVale </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
    .container{
        position:relative;
        font-size:65px;
        outline: none;
    }
    .container:focus{
        outline: none;
    }
    #gl-canvas{
        z-index:0;
    }
    #text-canvas{
        pointer-events: none;
        position:absolute;
        left:0px;
        top:0px;
        z-index:1;
    }
    </style>

    <link rel="stylesheet" type="text/css" href="res/style.css">

</head>

<script id="vertex-shader" type="x-shader/x-vertex">
precision mediump float;
attribute vec4 vPosition;
attribute vec3 vNormal;
attribute vec4 vColor;
uniform mat4 projectionMatrix;
uniform mat4 modelViewMatrix;
uniform mat4 shadowMatrix;
varying vec4 fColor;

varying float magnitude;

//Texturing...
attribute vec2 vTexCoord;
varying vec2 fTexCoord;

//Lighting...
uniform vec4 ambientProduct, diffuseProduct, specularProduct;
uniform vec4 lightPosition;
uniform float shininess;


void main()
{
    vec4 pos = modelViewMatrix * vPosition;
    vec3 position = -(pos).xyz;
    vec3 light = -lightPosition.xyz;
    vec3 L = normalize(light-position);

    //Distance fall off.
    float dist = length(light-position);
    float attenuation = 1.0/(0.5 + 0.25*dist + 0.1*dist*dist);

    vec3 E = normalize(-position);
    vec3 H = normalize(L+E);

    vec4 NN = vec4(vNormal,0);
    vec3 N = normalize((modelViewMatrix*NN).xyz);

    vec4 ambient = ambientProduct;

    float KD = max(dot(L,N),0.0);
    vec4 diffuse = KD*diffuseProduct*attenuation;

    float KS = pow(max(dot(N,H),0.0),shininess);
    vec4 specular = KS*specularProduct;

    if(dot(L,N)<0.0) specular = vec4(0.0,0.0,0.0,1.0);

    fColor = (ambient+diffuse+specular) * vColor;
    //fColor = vColor;
    //fColor = (diffuse + ambient)*vColor;

    fTexCoord = vTexCoord;

    gl_PointSize = 5.0;

    gl_Position = projectionMatrix*modelViewMatrix*vPosition;


    magnitude = length((gl_Position).xy);
}
</script>

<script id="fragment-shader" type="x-shader/x-fragment">
precision mediump float;

varying vec4 fColor;

varying float magnitude;

varying vec2 fTexCoord;
uniform sampler2D texture;

uniform bool disableTex;

uniform vec4 sColor;

//Cursor
uniform bool cursorBlock;

//Particle
uniform bool isParticle;
uniform vec4 particleColor;

//Ceilings
uniform bool isCeiling;
uniform float opacityFactor;
uniform bool inDungeon;

void main()
{


    gl_FragColor = texture2D(texture, fTexCoord )*fColor;
    //gl_FragColor = fColor;

    if(fTexCoord[0] > 1.0 || fTexCoord[1] > 1.0)
        gl_FragColor = fColor;

    if(sColor[0] == 0.0){
        vec2 uv = gl_FragCoord.xy / vec2(1280, 720);
        vec2 centered = uv - vec2(0.5);
        float dist = length(centered);
        float fade = smoothstep(0.5, 0.0, dist);
        gl_FragColor = vec4(sColor.rgb, sColor.a*fade);
        return;
    }

    if(cursorBlock == true){
        gl_FragColor = texture2D(texture, fTexCoord )*fColor*vec4(1.0, 1.0, 1.0, 0.3);
        return;
    }

    if(isParticle == true){
        gl_FragColor = particleColor;
        return;
    }

    if(isCeiling == true && inDungeon != true ){
        vec2 uv = gl_FragCoord.xy / vec2(1280, 720);
        vec2 centered = uv - vec2(0.5,0.6);
        float dist = length(centered);
        float fade = smoothstep(0.4, 0.0, dist);
        float sub = fade-opacityFactor;
        gl_FragColor = vec4((texture2D(texture, fTexCoord )*fColor).xyz,(1.0-sub));
        return;
    }

    if(isCeiling == true && inDungeon == true ){
        vec2 uv = gl_FragCoord.xy / vec2(1280, 720);
        vec2 centered = uv - vec2(0.5,0.5);
        float dist = length(centered);
        float fade = smoothstep(0.75, 0.1, dist);
        float sub = fade-opacityFactor;
        gl_FragColor = vec4((texture2D(texture, fTexCoord )*fColor).xyz,(1.0-sub));
        return;
    }
}
</script>

<script type="text/javascript" src="voxelvale/Common/webgl-utils.js"></script>
<script type="text/javascript" src="voxelvale/Common/initShaders.js"></script>
<script type="text/javascript" src="voxelvale/Common/MV.js"></script>

<script type="text/javascript" src="voxelvale/code/worldgen.js"></script>
<script type="text/javascript" src="voxelvale/code/datastructures.js"></script>
<script type="text/javascript" src="voxelvale/code/controls.js"></script>
<script type="text/javascript" src="voxelvale/code/modelingtools.js"></script>
<script type="text/javascript" src="voxelvale/code/main.js"></script>
<script type="text/javascript" src="voxelvale/code/player.js"></script>
<script type="text/javascript" src="voxelvale/code/tile.js"></script>
<script type="text/javascript" src="voxelvale/code/blockwall.js"></script>
<script type="text/javascript" src="voxelvale/code/xyzblock.js"></script>
<script type="text/javascript" src="voxelvale/code/dropbox.js"></script>
<script type="text/javascript" src="voxelvale/code/scenes.js"></script>
<script type="text/javascript" src="voxelvale/code/dungeons.js"></script>
<script type="text/javascript" src="voxelvale/code/collision.js"></script>
<script type="text/javascript" src="voxelvale/code/collisions.js"></script>
<script type="text/javascript" src="voxelvale/code/enemy.js"></script>
<script type="text/javascript" src="voxelvale/code/enemyroller.js"></script>
<script type="text/javascript" src="voxelvale/code/notifications.js"></script>
<script type="text/javascript" src="voxelvale/code/UI.js"></script>
<script type="text/javascript" src="voxelvale/code/uifunctions.js"></script>
<script type="text/javascript" src="voxelvale/code/inventory.js"></script>
<script type="text/javascript" src="voxelvale/code/craftingmenu.js"></script>
<script type="text/javascript" src="voxelvale/code/item.js"></script>
<script type="text/javascript" src="voxelvale/code/recipes.js"></script>
<script type="text/javascript" src="voxelvale/code/projectiles.js"></script>
<script type="text/javascript" src="voxelvale/code/structures.js"></script>
<script type="text/javascript" src="voxelvale/code/buildingfunctions.js"></script>
<script type="text/javascript" src="voxelvale/code/specialblocks.js"></script>
<script type="text/javascript" src="voxelvale/code/interactiveblocks.js"></script>
<script type="text/javascript" src="voxelvale/code/cursorfunctions.js"></script>
<script type="text/javascript" src="voxelvale/code/particles.js"></script>
<script type="text/javascript" src="voxelvale/code/music.js"></script>
<script type="text/javascript" src="voxelvale/code/sounds.js"></script>
<script type="text/javascript" src="voxelvale/code/saveload.js"></script>

<!-- Move to seperate file -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyA36b4yGnT6k620PHwRupLgoykeGML2_j4",
        authDomain: "voxelvale-fec75.firebaseapp.com",
        projectId: "voxelvale-fec75",
        storageBucket: "voxelvale-fec75.firebasestorage.app",
        messagingSenderId: "290314560027",
        appId: "1:290314560027:web:9478b33ec2aa6ffcb00ebe",
        measurementId: "G-DVMHH5L9SL"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const database = getFirestore(app);

    let displayName = null;

    window.signUp = async function (){
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;

        createUserWithEmailAndPassword(auth, email, pass)
        .then((userCredential) =>{
            //Do sign up stuff
            const user = userCredential.user;

            sendEmailVerification(user)
                .then(() =>{
                    alert("Verification email sent! Please check your inbox.")
                })
                .catch((error) =>{
                    console.error("Error sending vertication email:", error.message);
                })

        })
        .catch((error)=>{
            const code = error.code;

            switch (code) {
                case "auth/email-already-in-use":
                    alert("An account already exists with this email.");
                    break;
                case "auth/weak-password":
                    alert("Password should be at least 6 characters.");
                    break;
                case "auth/invalid-email":
                    alert("Please enter a valid email address.");
                    break;
                default:
                    alert("Signup error: " + error.message);
            }
        });
    }


    window.logIn = async function() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;

        signInWithEmailAndPassword(auth, email, pass)
        .then((user) => {
            //Do sign in stuff.
        })
        .catch((error) => {
            const code = error.code;
            alert("Invalid credentials.")

        } );
    }

    window.logOut = async function () {
        signOut(auth).then(() => {});
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            displayName = user.email;
            //document.getElementById("username").innerHTML = displayName;
            document.getElementById("loggedout").style.visibility = "hidden";
            document.getElementById("loggedin").style.visibility = "visible";
            document.getElementById("useremail").innerHTML = displayName;
            // You can now load or save data for this user!
        } else {
            
            document.getElementById("loggedout").style.visibility = "visible";
            document.getElementById("loggedin").style.visibility = "hidden";
            //document.getElementById("username").innerHTML = "Not signed in.";
           // document.getElementById("authchange").innerHTML = '<ul style="padding-right:0px; padding-left:0px;"> <li  style="padding-right:10px; padding-right:10px;margin: 0px;"> <input type="email" id="email" placeholder="Email"></input></li> <li  style="padding-right:10px; padding-right:10px;margin: 0px; margin-right: 10px;"> <input type="password" id="password" placeholder="Password"></input></li><li  style="padding:5px;padding-right:10px;margin: 0px;"> Login</li><li  style="padding:5px;padding-right:10px;margin: 0px;"> Sign up</li></ul>'
        }
    });


    const myWorld = {
        name: "My First World",
        width: 20,
        height: 20,
        tiles: [
        [0, 1, 1, 0],
        [0, 0, 1, 1]
        ]
    };

    window.saveWorld = async function(worldData) {
        const user = auth.currentUser;
        if (!user) {
            alert("You must be logged in to save!");
            return;
        }

        const ref = doc(collection(database, "users", user.uid, "worlds"), "main");

        let info = getWorldObj();

        try {
            await setDoc(ref, {
                xPos: info[0],
                yPos: info[1],
                zPos: info[2],
                objectNumbers: info[3]
                //lastModified: new Date().toISOString()
            });
            console.log("World saved!");
        } catch (err) {
            console.error("Save error:", err.message);
        }
    }

    window.loadWorld = async function(){
        const user = auth.currentUser;
        if(!user){
            alert("You must be logged in to load your world!");
            return;
        }
        const ref = doc(collection(database, "users", user.uid, "worlds"), "main");
        let loadedWorld = null;
        try {
            const snapshot = await getDoc(ref);
            if (snapshot.exists()) {
                loadedWorld = snapshot.data();
                
            } else {
                alert("You haven't saved a world yet!");
            }
        } catch (err) {
            console.error("Load error:", err.message);
        }
        if(loadedWorld!=null){
            loadWorldIntoGame(loadedWorld);
            console.log('Done!');
        }
    }

</script>




<body style="background-color: rgb(var(--color-bg));" id="body">
    <header>
       <div style="float:left; padding-left:25px; margin:0px;"class="vertical-center"> <img border="0" style="image-rendering: pixelated;" width="151%" src="res/logo.png"></div>
       
        <nav  class="vertical-center" style="text-align: center;right:0px; width:100%;">
            <a class = "navbox" href="#about">About</a>
            <a class = "navbox" href="#attributions">Atributions</a>
            <a class = "navbox" target="_blank" rel="noopener noreferrer" href="https://patreon.com/VoxelVale">Patreon</a>
        </nav>
        <nav class="vertical-center" style="padding-right:0px; padding-left: 0px;right: 0px; visibility: hidden" id = "loggedout">
          <ul style="padding-right:0px; padding-left:0px;">
            <li  style="padding-right:10px; padding-right:10px;margin: 0px; margin-top:4px;"> <input type="email" id="email" placeholder="Email"></input></li>
            <li  style="padding-right:10px; padding-right:10px;margin: 0px; margin-right: 10px; margin-top:4px;"> <input type="password" id="password" placeholder="Password"></input></li>
            <li  style="padding:5px;padding-right:10px;margin: 0px;"> <button onclick="logIn()">Log In</button></li>
            <li  style="padding:5px;padding-right:10px;margin: 0px;"> <button onclick="signUp();">Sign Up</button></li>
          </ul>
        </nav>
        <nav class="vertical-center" style="padding-right:0px; padding-left: 0px;right: 0px; visibility:hidden;" id = "loggedin">
          <ul style="padding-right:0px; padding-left:0px;">
            <li  style="padding:5px;padding-right:10px;margin: 0px; margin-right: 10px;margin-top:1px;" id="useremail"> </li>
            <li  style="padding:5px;padding-right:10px;margin: 0px;margin-right:10px;"><button onclick="logOut()">Log Out</button></li>
          </ul>
        </nav>
  </header>
    <!-- GAME CONTAINER -->
    <div class="gameBackground" style="padding-top:97px;">
        <div style="padding: 1rem 1rem;   max-width: 1280px;  margin: auto; ">
            <div class="gameBorder colorStyle" style="height: 720px; padding:0px;">   
                <div class=container>
                    <canvas id="gl-canvas" width="1280" height="720" stencil="true">
                    <!-- The following message is displayed if the browser doesn’t -- support HTML5 -->
                    Sorry; your web browser does not support HTML5’s canvas element.
                    </canvas>
                    <canvas id="text-canvas" width="1280" height="720"></canvas>
                </div>
            </div>
        </div>
        <div style="text-align: center; font-size: 11px; color:#000">Version: Alpha 0.0.1 | Report Bugs</div>
    </div>
    <div style="margin: auto;scroll-margin-top: 80px;" id="about">
        <div class="boxBorder colorStyle">   
            <h1>About</h1>
            <hr class="section-underline">
            <div class = "textBox">
                VoxelVale is a cozy, browser-based game inspired by the blocky freedom of Minecraft and the unpredictable exploration of The Binding of Isaac. Built from the ground up using JavaScript and WebGL, this project is a personal experiment in creativity, coding, and nostalgic design.<br><br>

                In this world, you’ll explore pixelated landscapes, uncover secrets, and build your own path—literally. Whether you're here to relax, dig, fight, or just vibe out to lo-fi textures and soft palettes, this little game is yours to wander.<br><br>

                This is a solo dev project. Everything you see—from the engine to the lighting to the interface—was handcrafted in raw WebGL and JavaScript.<br><br>

                Enjoy, and thanks for stopping by!

                To get updates on the development follow me on Patreon! Cloud saves. Play for free.
            </div>
        </div>
    </div>

    <div style="margin: auto; scroll-margin-top: 80px;" id="attributions">
        <div class="boxBorder colorStyle">   
            <h1>Attributions</h1>
            <hr class="section-underline">
            <div class = "textBox">
                I'd like to thank all these guys for providing stuff.

                <h2> Music (Overworld)</h2>
                <ul>
                    <li><a class="linkstyle" href="https://opengameart.org/content/snowfall"> Snowfall | Kistol </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/old-city-theme"> Old City Theme | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/chill-lofi-inspired  "> Chill lofi  | omfgdude </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/vampires-piano"> Vampire's Piano | TAD </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/nature-theme-sketch"> Nature Theme | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/town-theme"> Town Theme | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/snow-city-theme"> Snow City | Tarush Singhal </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/emotional-mood-piece"> Emotional Mood Piece | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/safe-room-theme"> Safe Room Theme | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/hungry-tribes"> Hungry Tribes | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/dreamlike-state"> Dreamlike State | Tarush Singhal </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/8-bit-prairie"> 8 Bit Prairie | Tarush Singhal </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/8-bit-summer-memory"> 8 bit summer memory | Tarush Singhal </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/small-town"> Small Town | Tarush Singhal </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/forest-7"> Forest | Tarush Singhal </a></li>
                </ul>
                <h2> Music (Caves/Dungeons)</h2>
                <ul>
                    <li><a class="linkstyle" href="https://opengameart.org/content/franz-liszt-19-hungarian-rhapsodies"> Franz Liszt - 19 Hungarian Rhapsodies | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/infiltrator"> Infiltrator | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/feeding-frenzy"> Feeding Frenzy | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/dungeon-theme"> Dungeon Theme | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/palm-of-my-hand-at-the-altar"> Palm of my hand - At the altar | Harold Azmed </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/palm-of-my-hand-intro"> Palm of my hand - Intro | Harold Azmed </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/deep-space-flight"> Deep Space Flight | remaxim </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/dungeon-king"> Dungeon King | professorlamp </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/dungeon-dwellers-dungeon-track-for-rpg"> Dungeon Dwellers | BitsAndPiecesMusic </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/cold-sanctuary-rpg-orchestral-essentials-dungeon-music"> Cold Sanctuary </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/rpg-ambience-dungeon"> RPG Ambience - Dungeon | Hitctrl </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/wander-in-a-dungeon"> Wander in a dungeon | Kosmo The Cat </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/dungeon-chip"> Dungeon chip | divjedrevo </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/zelda-like-dungeon-theme"> Zelda-like Dungeon theme | genderfreak </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/small-dungeon"> SMALL dungeon | genderfreak </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/dungeon-deep-0"> Dungeon Deep | Eldritch Grim </a></li>
                </ul>
                <h2> Sound Effects </h2>
                <ul>
                    <li><a class="linkstyle" href="https://opengameart.org/content/foot-walking-step-sounds-on-stone-water-snow-wood-and-dirt"> Foot walking step sounds | Jute </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/door-open-door-close-set"> Door Open, Door Close Set | qubodup </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/impact"> Impact | qubodup </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/bubbles-pop"> bubbles 'pop' | farfadet46 </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/monster-sound-effects-pack"> Monster Sound Effects Pack | Ogrebane </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/door-open-door-close"> Door open, door close | Iwan Gabovitch </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/monster-sound-pack-volume-1"> Monster Sound Pack, Volume 1 | Ogrebane </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/footsteps-leather-cloth-armor"> Footsteps Leather, Cloth, Armor | HaelDB </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/swishes-sound-pack"> Swishes Sound Pack | artisticdude </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/bow-arrow-shot"> Bow & Arrow Shot </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/medieval-sound-effects-weapon-textures"> Medieval sound effects | Ben Jaszczak & Brian Nelson </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/thwack-sounds"> Thwack Sounds | AntumDeluge </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/stop"> Stop | Blender Foundation </a></li>
                    <li><a class="linkstyle" href="https://opengameart.org/content/vibrating-plastic"> Vibrating Plastic | remaxim </a></li>
                </ul>
            </div>
        </div>
    </div>

    <!--
    <br><br><br><br><br><br>

    <button onclick="saveWorld()">Save World</button>-->
    <!--
    <button onclick="getWorldObj()">Save World</button>
    
    <button onclick="saveWorld()">Save World To Firebase</button>

    <button onclick="loadWorld()">Load World From Firebase</button>


        <b> Sign up / Login </b>
   
    
    <button onclick="signUp();">Sign Up</button>
    <button onclick="logIn()">Log In</button>
    <button onclick="logOut()">Log Out</button>


    

    <br><br><br>

       <br><br><br>
    <span id = "username"></span><br>
 <b>Attributions:</b> I'm stuff<br><br>
-->
</body>

<script type="text/javascript">
    var socket = io();
    var initialized = false;
</script>

<script type="text/javascript" src="net.js"></script>

<img id="scream" src="voxelvale/code/textures/textures.png" width="256" height="256" hidden></img>
<canvas id="myCanvas" width="256" height="256" hidden></canvas>

</html>